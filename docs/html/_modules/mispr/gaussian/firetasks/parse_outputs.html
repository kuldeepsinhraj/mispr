<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" />

    <meta name="generator" content="sphinx-5.1.1, furo 2022.06.21"/>
        <title>mispr.gaussian.firetasks.parse_outputs - Materials informatics for structure-property relationships</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/rtd_sphinx_search.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #991B1E;
  --color-brand-content: #991B1E;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">Materials informatics for structure-property relationships</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Materials informatics for structure-property relationships</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../../installation/index.html">Installation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation/dependencies.html">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation/configuration.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation/test.html">Running a Test Workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../keywords.html">Keywords</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WORKFLOWS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows/concept.html">Workflow Concept and Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows/supported.html">Supported Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows/tutorials.html">Workflow Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows/custom.html">Creating Custom Workflows</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RESOURCES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/resources.html">Helpful Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DEVELOPMENT</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../citing.html">Citing MISPR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for mispr.gaussian.firetasks.parse_outputs</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>


<span class="c1"># Defines firetasks for parsing Gaussian output files.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">img</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>

<span class="kn">from</span> <span class="nn">fireworks.fw_config</span> <span class="kn">import</span> <span class="n">CONFIG_FILE_DIR</span>
<span class="kn">from</span> <span class="nn">fireworks.core.firework</span> <span class="kn">import</span> <span class="n">FWAction</span><span class="p">,</span> <span class="n">FiretaskBase</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_utilities</span> <span class="kn">import</span> <span class="n">explicit_serialize</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_serializers</span> <span class="kn">import</span> <span class="n">DATETIME_HANDLER</span>

<span class="kn">from</span> <span class="nn">pymatgen.io.gaussian</span> <span class="kn">import</span> <span class="n">GaussianInput</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Molecule</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.graphs</span> <span class="kn">import</span> <span class="n">MoleculeGraph</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.local_env</span> <span class="kn">import</span> <span class="n">OpenBabelNN</span>

<span class="kn">from</span> <span class="nn">mispr</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">mispr_version</span>
<span class="kn">from</span> <span class="nn">mispr.gaussian.utilities.mol</span> <span class="kn">import</span> <span class="n">process_mol</span>
<span class="kn">from</span> <span class="nn">mispr.gaussian.utilities.gout</span> <span class="kn">import</span> <span class="n">process_run</span>
<span class="kn">from</span> <span class="nn">mispr.gaussian.utilities.misc</span> <span class="kn">import</span> <span class="n">pass_gout_dict</span>
<span class="kn">from</span> <span class="nn">mispr.gaussian.utilities.dbdoc</span> <span class="kn">import</span> <span class="n">add_solvent_to_prop_dict</span>
<span class="kn">from</span> <span class="nn">mispr.gaussian.utilities.files</span> <span class="kn">import</span> <span class="n">bibtex_parser</span>
<span class="kn">from</span> <span class="nn">mispr.gaussian.utilities.rdkit</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_rdkit_mol</span><span class="p">,</span>
    <span class="n">draw_rdkit_mol_with_highlighted_bonds</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mispr.gaussian.utilities.metadata</span> <span class="kn">import</span> <span class="n">get_chem_schema</span>
<span class="kn">from</span> <span class="nn">mispr.gaussian.utilities.db_utilities</span> <span class="kn">import</span> <span class="n">get_db</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Rasha Atwi&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Rasha Atwi&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;rasha.atwi@stonybrook.edu&quot;</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;Jan 2021&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.0.1&quot;</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">DEFAULT_KEY</span> <span class="o">=</span> <span class="s2">&quot;gout_key&quot;</span>
<span class="n">HARTREE_TO_EV</span> <span class="o">=</span> <span class="mf">27.2114</span>
<span class="n">HARTREE_TO_KJ</span> <span class="o">=</span> <span class="mi">2600</span>
<span class="n">FARAD</span> <span class="o">=</span> <span class="mf">96.5</span>
<span class="n">R</span> <span class="o">=</span> <span class="mf">8.31446</span>


<div class="viewcode-block" id="ProcessRun"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.ProcessRun">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">ProcessRun</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes Gaussian output files from a single run. Enters the</span>
<span class="sd">    run to db and/or creates a summary json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        run (GaussianOutput, str, dict): the actual Gaussian run; type</span>
<span class="sd">            depends on the operation_type</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        operation_type (str): Type of operation to be performed; refer</span>
<span class="sd">            to mispr.gaussian.utilities.gout.process_run for workflows</span>
<span class="sd">            ones</span>
<span class="sd">        db (str or dict): database credentials to store the run; could</span>
<span class="sd">            be provided as the path to the db.json file or in the form</span>
<span class="sd">            of a dictionary</span>
<span class="sd">        save_to_db (bool): whether to save the run to db</span>
<span class="sd">        save_to_file (bool): whether to save the run to a json file</span>
<span class="sd">        filename (str): name of the json file to save the run to; uses</span>
<span class="sd">            &quot;run.json&quot; if not provided</span>
<span class="sd">        input_file (str): the input file for the run; used for adding</span>
<span class="sd">            Gaussian input parameters to the final Gaussian dictionary;</span>
<span class="sd">            if not specified, will get these parameters from the run</span>
<span class="sd">            itself, but in this case, &quot;input_parameters&quot; usually</span>
<span class="sd">            specified at the end of the Gaussian input file will not be</span>
<span class="sd">            saved since they are not easily retrieved from the Gaussian</span>
<span class="sd">            output file</span>
<span class="sd">        gout_key (str): the key to use for the run in the mod_spec dict</span>
<span class="sd">            passed to FWAction; used when contents of the run are needed</span>
<span class="sd">            in other tasks</span>
<span class="sd">        format_chk (bool): whether to create a formatted check file</span>
<span class="sd">            from the Gaussian checkpoint file</span>
<span class="sd">        formchk_cmd (str): the full command to use for formatting the</span>
<span class="sd">            checkpoint file; if not provided, will attempt to find one</span>
<span class="sd">            in the configuration files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;operation_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gout_key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;format_chk&quot;</span><span class="p">,</span>
        <span class="s2">&quot;formchk_cmd&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="ProcessRun.run_task"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.ProcessRun.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]</span>
        <span class="n">operation_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation_type&quot;</span><span class="p">,</span> <span class="s2">&quot;get_from_gout&quot;</span><span class="p">)</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_file&quot;</span><span class="p">)</span>
        <span class="n">working_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format_chk&quot;</span><span class="p">):</span>
            <span class="n">found_chk</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.chk&quot;</span><span class="p">):</span>
                    <span class="n">found_chk</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">chk_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.chk&quot;</span><span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formchk_cmd&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
                        <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
                        <span class="n">cfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">CONFIG_FILE_DIR</span> <span class="o">+</span> <span class="s2">&quot;/config.ini&quot;</span><span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;RunCalc&quot;</span><span class="p">][</span><span class="s2">&quot;formchkcmd&quot;</span><span class="p">]</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$input_path$&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;$output_path$&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chk_file</span><span class="si">}</span><span class="s2">.fchk&quot;</span>
                    <span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running command: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                    <span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Finished running with return code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">found_chk</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_chk</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No checkpoint file found in </span><span class="si">{</span><span class="n">working_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">gout_dict</span> <span class="o">=</span> <span class="n">process_run</span><span class="p">(</span>
            <span class="n">operation_type</span><span class="o">=</span><span class="n">operation_type</span><span class="p">,</span>
            <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span>
            <span class="n">input_file</span><span class="o">=</span><span class="n">input_file</span><span class="p">,</span>
            <span class="n">working_dir</span><span class="o">=</span><span class="n">working_dir</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># get initial and final molecule</span>
        <span class="n">input_mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;molecule&quot;</span><span class="p">])</span>
        <span class="n">output_mol</span> <span class="o">=</span> <span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;molecule&quot;</span><span class="p">])</span>

        <span class="c1"># Build initial and final molgraphs</span>
        <span class="n">input_molgraph</span> <span class="o">=</span> <span class="n">MoleculeGraph</span><span class="o">.</span><span class="n">with_local_env_strategy</span><span class="p">(</span><span class="n">input_mol</span><span class="p">,</span> <span class="n">OpenBabelNN</span><span class="p">())</span>
        <span class="n">output_molgraph</span> <span class="o">=</span> <span class="n">MoleculeGraph</span><span class="o">.</span><span class="n">with_local_env_strategy</span><span class="p">(</span>
            <span class="n">output_mol</span><span class="p">,</span> <span class="n">OpenBabelNN</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Detect any structural change that occurred during calculation</span>
        <span class="k">if</span> <span class="n">input_molgraph</span><span class="o">.</span><span class="n">isomorphic_to</span><span class="p">(</span><span class="n">output_molgraph</span><span class="p">):</span>
            <span class="n">change</span> <span class="o">=</span> <span class="s2">&quot;no_change&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_graph</span> <span class="o">=</span> <span class="n">input_molgraph</span><span class="o">.</span><span class="n">graph</span>
            <span class="n">output_graph</span> <span class="o">=</span> <span class="n">output_molgraph</span><span class="o">.</span><span class="n">graph</span>
            <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(</span><span class="n">input_graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(</span>
                <span class="n">output_graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="n">change</span> <span class="o">=</span> <span class="s2">&quot;unconnected_fragments&quot;</span>
            <span class="k">elif</span> <span class="n">output_graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">input_graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">():</span>
                <span class="n">change</span> <span class="o">=</span> <span class="s2">&quot;fewer_bonds&quot;</span>
            <span class="k">elif</span> <span class="n">output_graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">input_graph</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">():</span>
                <span class="n">change</span> <span class="o">=</span> <span class="s2">&quot;more_bonds&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">change</span> <span class="o">=</span> <span class="s2">&quot;bond_change&quot;</span>
        <span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;structural_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span>

        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="p">:</span>
            <span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;tag&quot;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;run_time&quot;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;wall_time (s)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_time&quot;</span><span class="p">]</span>
        <span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mispr_version</span>
        <span class="k">if</span> <span class="n">gout_dict</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;has_gaussian_completed&quot;</span><span class="p">]:</span>
            <span class="n">run_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_db&quot;</span><span class="p">):</span>
                <span class="n">runs_db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                <span class="n">run_id</span> <span class="o">=</span> <span class="n">runs_db</span><span class="o">.</span><span class="n">insert_run</span><span class="p">(</span><span class="n">gout_dict</span><span class="p">)</span>
                <span class="n">run_list</span><span class="p">[</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_id</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved parsed output to db&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_file&quot;</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">gout_dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DATETIME_HANDLER</span><span class="p">))</span>
                <span class="n">run_list</span><span class="p">[</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saved parsed output to json file&quot;</span><span class="p">)</span>

            <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gout_key&quot;</span><span class="p">)</span>
            <span class="n">set_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;gaussian_output-&gt;</span><span class="si">{</span><span class="n">DEFAULT_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">uid</span><span class="p">:</span>
                <span class="n">set_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;gaussian_output-&gt;</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gout_dict</span>
            <span class="c1"># fw_spec = {&#39;gaussian_output: {DEFAULT_KEY: gout_dict, uid: gout_dict}}</span>
            <span class="n">mod_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_set&quot;</span><span class="p">:</span> <span class="n">set_dict</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">run_list</span><span class="p">:</span>
                <span class="n">mod_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;_push&quot;</span><span class="p">:</span> <span class="n">run_list</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">mod_spec</span><span class="o">=</span><span class="n">mod_dict</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gaussian did not complete normally, Terminating&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RetrieveGaussianOutput"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.RetrieveGaussianOutput">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">RetrieveGaussianOutput</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a Gaussian output dict from fw_spec or the database,</span>
<span class="sd">    converts it to a GaussianInput object, and add it to fw_spec.</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        db (str or dict): database credentials; could be provided as</span>
<span class="sd">            the path to the db.json file or in the form of a dictionary</span>
<span class="sd">        gaussian_input_params (dict): parameters to use in creating the</span>
<span class="sd">            GaussianInput object; if not provided, will use the ones</span>
<span class="sd">            in the passed or retrieved Gaussian output dict</span>
<span class="sd">        run_id (str): id of the run to retrieve from the database;</span>
<span class="sd">            e.g. &quot;5e3737d9da0b1cbbd5d556f7&quot;</span>
<span class="sd">        inchi (str): InChI of the molecule; used as a query criteria</span>
<span class="sd">            to retrieve the run from the db</span>
<span class="sd">        functional (str): density functional of the run in the db;</span>
<span class="sd">            used as a query criteria</span>
<span class="sd">        basis (str): basis set of the run in the db; used as a query</span>
<span class="sd">            criteria</span>
<span class="sd">        type (str): type of the Gaussian job run in the db; e.g. &quot;opt&quot;</span>
<span class="sd">            or &quot;freq&quot;; used as a query criteria</span>
<span class="sd">        phase (str): phase of the run in the db; e.g. &quot;gas&quot; or</span>
<span class="sd">            &quot;solution&quot;; used as a query criteria</span>
<span class="sd">        tag (str): tag of the run in the db; used as a query criteria</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gaussian_input_params&quot;</span><span class="p">,</span>
        <span class="s2">&quot;run_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inchi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;functional&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phase&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tag&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="RetrieveGaussianOutput.run_task"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.RetrieveGaussianOutput.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>

        <span class="c1"># if a Gaussian output dict is passed through fw_spec</span>
        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gaussian_output&quot;</span><span class="p">):</span>
            <span class="n">run</span> <span class="o">=</span> <span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">DEFAULT_KEY</span><span class="p">)</span>
            <span class="c1"># run = fw_spec[&#39;gaussian_output&#39;][DEFAULT_KEY]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id&quot;</span><span class="p">):</span>
            <span class="n">run</span> <span class="o">=</span> <span class="n">process_run</span><span class="p">(</span>
                <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;get_from_run_id&quot;</span><span class="p">,</span>
                <span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id&quot;</span><span class="p">),</span>
                <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># otherwise, try to retrieve gaussian output from db</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;inchi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inchi&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smiles&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;functional&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="s2">&quot;tag&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">query</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">process_run</span><span class="p">(</span>
                    <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;get_from_run_query&quot;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ConnectionFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not connect to server: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># create a gaussian input object from run</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gaussian_input_params&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;No gaussian input parameters provided; will use &quot;</span>
                <span class="s2">&quot;run parameters&quot;</span>
            <span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">run</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># use gaussian_input_params if defined, otherwise use run parameters</span>
            <span class="n">inputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gaussian_input_params&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">run</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;molecule&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;molecule&quot;</span><span class="p">]</span>
        <span class="c1"># TODO: check if this works in all cases</span>
        <span class="c1">#  (if we are saving to db and removing the class)</span>
        <span class="c1"># inputs[&#39;molecule&#39;] = process_mol(&#39;get_from_run_dict&#39;, run)</span>
        <span class="n">gaussin</span> <span class="o">=</span> <span class="n">GaussianInput</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;gaussian_input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaussin</span></div></div>


<div class="viewcode-block" id="ESPtoDB"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.ESPtoDB">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">ESPtoDB</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enter an ESP run into the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys (list): list of keys of Gaussian runs in fw_spec to use in</span>
<span class="sd">            building the ESP document; e.g. these keys could correspond to</span>
<span class="sd">            optimization, frequency, and ESP jobs leading to the final</span>
<span class="sd">            result</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        db (str or dict): database credentials to store the run; could</span>
<span class="sd">            be provided as the path to the db.json file or in the form</span>
<span class="sd">            of a dictionary</span>
<span class="sd">        save_to_db (bool): whether to insert the ESP dict to the ESP</span>
<span class="sd">            collection in the db</span>
<span class="sd">        save_to_file (bool): whether to save the ESP dict to a json</span>
<span class="sd">            file; if True, will save to a file named &quot;esp.json&quot;</span>
<span class="sd">        additional_prop_doc_fields (dict): additional fields to add to</span>
<span class="sd">            the final ESP dict</span>
<span class="sd">        solvent_gaussian_inputs (str): gaussian inputs for the implicit</span>
<span class="sd">            solvent model to add to the final ESP dict, if any</span>
<span class="sd">        solvent_properties (dict): implicit solvent properties to add</span>
<span class="sd">            to the final ESP dict, if any</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="ESPtoDB.run_task"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.ESPtoDB.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
        <span class="n">gout_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="c1"># include opt fireworks in the list of gout_dict to calculate run time</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="n">gout_dict</span> <span class="o">+</span> <span class="p">[</span><span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;_opt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">full_gout_dict</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="n">process_mol</span><span class="p">(</span>
            <span class="s2">&quot;get_from_run_dict&quot;</span><span class="p">,</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">charge</span><span class="o">=</span><span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">mol_schema</span> <span class="o">=</span> <span class="n">get_chem_schema</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;phase&quot;</span><span class="p">]</span>

        <span class="c1"># if one calculation is skipped, wall time is considered zero</span>
        <span class="n">run_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">gout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wall_time (s)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">gout</span> <span class="ow">in</span> <span class="n">full_gout_dict</span><span class="p">])</span>

        <span class="n">esp_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;molecule&quot;</span><span class="p">:</span> <span class="n">molecule</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">],</span>
            <span class="s2">&quot;inchi&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;inchi&quot;</span><span class="p">],</span>
            <span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">],</span>
            <span class="s2">&quot;chemsys&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;chemsys&quot;</span><span class="p">],</span>
            <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;final_energy&quot;</span><span class="p">],</span>
            <span class="s2">&quot;esp&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;ESP_charges&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dipole_moment&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;dipole_moment&quot;</span><span class="p">],</span>
            <span class="s2">&quot;functional&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;functional&quot;</span><span class="p">],</span>
            <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">],</span>
            <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="p">,</span>
            <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;successful&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wall_time (s)&quot;</span><span class="p">:</span> <span class="n">run_time</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">mispr_version</span><span class="p">,</span>
            <span class="s2">&quot;gauss_version&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;gauss_version&quot;</span><span class="p">],</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;solution&quot;</span><span class="p">:</span>
            <span class="n">solvent_gaussian_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">)</span>
            <span class="n">solvent_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">esp_dict</span> <span class="o">=</span> <span class="n">add_solvent_to_prop_dict</span><span class="p">(</span>
                <span class="n">esp_dict</span><span class="p">,</span> <span class="n">solvent_gaussian_inputs</span><span class="p">,</span> <span class="n">solvent_properties</span>
            <span class="p">)</span>

        <span class="c1"># check if polarizability is available (from freq calc of esp workflow)</span>
        <span class="k">if</span> <span class="s2">&quot;polarizability&quot;</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]:</span>
            <span class="n">esp_dict</span><span class="p">[</span><span class="s2">&quot;polarizability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span>
                <span class="s2">&quot;polarizability&quot;</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">):</span>
            <span class="n">esp_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">):</span>
            <span class="n">esp_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_db&quot;</span><span class="p">):</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">insert_property</span><span class="p">(</span>
                <span class="s2">&quot;esp&quot;</span><span class="p">,</span>
                <span class="n">esp_dict</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;inchi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;chemsys&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">):</span>
            <span class="n">esp_dict</span><span class="p">[</span><span class="s2">&quot;run_locs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_file&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;run_ids&quot;</span> <span class="ow">in</span> <span class="n">esp_dict</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">esp_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;esp.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">esp_dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DATETIME_HANDLER</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;esp calculation complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="NMRtoDB"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.NMRtoDB">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">NMRtoDB</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enter an NMR run into the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        keys (list): list of keys of Gaussian runs in fw_spec to use in</span>
<span class="sd">            building the NMR document; e.g. these keys could correspond to</span>
<span class="sd">            optimization, frequency, and NMR jobs leading to the final</span>
<span class="sd">            result</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        db (str or dict): database credentials to store the run; could</span>
<span class="sd">            be provided as the path to the db.json file or in the form</span>
<span class="sd">            of a dictionary</span>
<span class="sd">        save_to_db (bool): whether to insert the NMR dict to the NMR</span>
<span class="sd">            collection in the db</span>
<span class="sd">        save_to_file (bool): whether to save the NMR dict to a json</span>
<span class="sd">            file; if True, will save to a file named &quot;nmr.json&quot;</span>
<span class="sd">        additional_prop_doc_fields (dict): additional fields to add to</span>
<span class="sd">            the final NMR dict</span>
<span class="sd">        solvent_gaussian_inputs (str): gaussian inputs for the implicit</span>
<span class="sd">            solvent model to add to the final NMR dict, if any</span>
<span class="sd">        solvent_properties (dict): implicit solvent properties to add</span>
<span class="sd">            to the final NMR dict, if any</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="NMRtoDB.run_task"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.NMRtoDB.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
        <span class="n">gout_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="c1"># include opt fireworks in the list of gout_dict to calculate run time</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="n">gout_dict</span> <span class="o">+</span> <span class="p">[</span><span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;_opt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">full_gout_dict</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="n">process_mol</span><span class="p">(</span>
            <span class="s2">&quot;get_from_run_dict&quot;</span><span class="p">,</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">charge</span><span class="o">=</span><span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">mol_schema</span> <span class="o">=</span> <span class="n">get_chem_schema</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;phase&quot;</span><span class="p">]</span>

        <span class="c1"># if one calculation is skipped, wall time is considered zero</span>
        <span class="n">run_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">gout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wall_time (s)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">gout</span> <span class="ow">in</span> <span class="n">full_gout_dict</span><span class="p">])</span>

        <span class="n">nmr_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;molecule&quot;</span><span class="p">:</span> <span class="n">molecule</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">],</span>
            <span class="s2">&quot;inchi&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;inchi&quot;</span><span class="p">],</span>
            <span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">],</span>
            <span class="s2">&quot;chemsys&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;chemsys&quot;</span><span class="p">],</span>
            <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;final_energy&quot;</span><span class="p">],</span>
            <span class="s2">&quot;tensor&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;tensor&quot;</span><span class="p">],</span>
            <span class="s2">&quot;functional&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;functional&quot;</span><span class="p">],</span>
            <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">],</span>
            <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="p">,</span>
            <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;successful&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wall_time (s)&quot;</span><span class="p">:</span> <span class="n">run_time</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">mispr_version</span><span class="p">,</span>
            <span class="s2">&quot;gauss_version&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;gauss_version&quot;</span><span class="p">],</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;solution&quot;</span><span class="p">:</span>
            <span class="n">solvent_gaussian_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">)</span>
            <span class="n">solvent_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">nmr_dict</span> <span class="o">=</span> <span class="n">add_solvent_to_prop_dict</span><span class="p">(</span>
                <span class="n">nmr_dict</span><span class="p">,</span> <span class="n">solvent_gaussian_inputs</span><span class="p">,</span> <span class="n">solvent_properties</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">):</span>
            <span class="n">nmr_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">):</span>
            <span class="n">nmr_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_db&quot;</span><span class="p">):</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">insert_property</span><span class="p">(</span>
                <span class="s2">&quot;nmr&quot;</span><span class="p">,</span>
                <span class="n">nmr_dict</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;inchi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;chemsys&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">):</span>
            <span class="n">nmr_dict</span><span class="p">[</span><span class="s2">&quot;run_locs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_file&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;run_ids&quot;</span> <span class="ow">in</span> <span class="n">nmr_dict</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">nmr_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;nmr.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">nmr_dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DATETIME_HANDLER</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;nmr calculation complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="BindingEnergytoDB"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.BindingEnergytoDB">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">BindingEnergytoDB</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enter a binding energy run into the database. The binding energy</span>
<span class="sd">    value is in eV.</span>

<span class="sd">    Args:</span>
<span class="sd">        index (list): list of indices of the two sites in the molecules</span>
<span class="sd">            at which they are expected to bind</span>
<span class="sd">        keys (list): list of keys of Gaussian runs in fw_spec to use in</span>
<span class="sd">            building the binding energy document; e.g. these keys could</span>
<span class="sd">            correspond to set of optimization and frequency jobs leading</span>
<span class="sd">            to the final result</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        db (str or dict): database credentials to store the run; could</span>
<span class="sd">            be provided as the path to the db.json file or in the form</span>
<span class="sd">            of a dictionary</span>
<span class="sd">        save_to_db (bool): whether to insert the binding energy dict to</span>
<span class="sd">            the binding energy collection in the db</span>
<span class="sd">        save_to_file (bool): whether to save the binding energy dict to</span>
<span class="sd">            a json file; if True, will save to a file named</span>
<span class="sd">            &quot;binding_energy.json&quot;</span>
<span class="sd">        additional_prop_doc_fields (dict): additional fields to add to</span>
<span class="sd">            the final binding energy dict</span>
<span class="sd">        solvent_gaussian_inputs (str): gaussian inputs for the implicit</span>
<span class="sd">            solvent model to add to the final binding energy dict, if any</span>
<span class="sd">        solvent_properties (dict): implicit solvent properties to add</span>
<span class="sd">            to the final binding energy dict, if any</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="BindingEnergytoDB.run_task"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.BindingEnergytoDB.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
        <span class="n">gout_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="c1"># include opt fireworks in the list of gout_dict to calculate run time</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="n">gout_dict</span> <span class="o">+</span> <span class="p">[</span><span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;_opt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">full_gout_dict</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">molecules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">process_mol</span><span class="p">(</span><span class="s2">&quot;get_from_run_dict&quot;</span><span class="p">,</span> <span class="n">gout</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">gout</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">gout</span> <span class="ow">in</span> <span class="n">gout_dict</span>
        <span class="p">]</span>
        <span class="n">final_energies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">gout</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;final_energy&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gout</span> <span class="ow">in</span> <span class="n">gout_dict</span>
        <span class="p">]</span>
        <span class="c1"># be_key = &#39;binding_energy_{}_{}_eV&#39;.format(</span>
        <span class="c1">#     str(molecules[0].species[index[0]]) + str(index[0]),</span>
        <span class="c1">#     str(molecules[1].species[index[1]]) + str(len(molecules[0]) +</span>
        <span class="c1">#                                               index[1]))</span>

        <span class="n">be_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">final_energies</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">final_energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">final_energies</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">HARTREE_TO_EV</span>

        <span class="n">be</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sites&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;atoms&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">molecules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">molecules</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
            <span class="p">),</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">be_value</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mol_schema</span> <span class="o">=</span> <span class="n">get_chem_schema</span><span class="p">(</span><span class="n">molecules</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;phase&quot;</span><span class="p">]</span>
        <span class="c1"># if one calculation is skipped, wall time is considered zero</span>
        <span class="n">run_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">gout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wall_time (s)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">gout</span> <span class="ow">in</span> <span class="n">full_gout_dict</span><span class="p">])</span>

        <span class="n">be_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;molecule&quot;</span><span class="p">:</span> <span class="n">molecules</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">],</span>
            <span class="s2">&quot;inchi&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;inchi&quot;</span><span class="p">],</span>
            <span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">],</span>
            <span class="s2">&quot;chemsys&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;chemsys&quot;</span><span class="p">],</span>
            <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">final_energies</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;be_eV&quot;</span><span class="p">:</span> <span class="n">be</span><span class="p">,</span>
            <span class="s2">&quot;functional&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;functional&quot;</span><span class="p">],</span>
            <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">],</span>
            <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;phase&quot;</span><span class="p">],</span>
            <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;successful&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wall_time (s)&quot;</span><span class="p">:</span> <span class="n">run_time</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">mispr_version</span><span class="p">,</span>
            <span class="s2">&quot;gauss_version&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;gauss_version&quot;</span><span class="p">],</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;solution&quot;</span><span class="p">:</span>
            <span class="n">solvent_gaussian_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">)</span>
            <span class="n">solvent_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">be_dict</span> <span class="o">=</span> <span class="n">add_solvent_to_prop_dict</span><span class="p">(</span>
                <span class="n">be_dict</span><span class="p">,</span> <span class="n">solvent_gaussian_inputs</span><span class="p">,</span> <span class="n">solvent_properties</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">):</span>
            <span class="n">be_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">):</span>
            <span class="n">be_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_db&quot;</span><span class="p">):</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">insert_property</span><span class="p">(</span>
                <span class="s2">&quot;binding_energy&quot;</span><span class="p">,</span>
                <span class="n">be_dict</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;inchi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;chemsys&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">):</span>
            <span class="n">be_dict</span><span class="p">[</span><span class="s2">&quot;run_locs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_file&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;run_ids&quot;</span> <span class="ow">in</span> <span class="n">be_dict</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">be_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;binding_energy.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">be_dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DATETIME_HANDLER</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;binding energy calculation complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="IPEAtoDB"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.IPEAtoDB">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">IPEAtoDB</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inserts a redox potential run into the database. Saves both gibbs</span>
<span class="sd">    free energies and redox potentials. If a calculation is performed in</span>
<span class="sd">    multiple steps, saves all intermediate energies.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_electrons (int): number of electrons transferred;</span>
<span class="sd">        states (list): list of states used in the calculation; e.g.</span>
<span class="sd">            [&quot;cation&quot;] for oxidation, [&quot;anion&quot;] for reduction, or</span>
<span class="sd">            [&quot;cation&quot;, &quot;anion&quot;] for oxidation and reduction calculations</span>
<span class="sd">        phases (list): list of phases to involved in the calculations;</span>
<span class="sd">            e.g. [&quot;solution&quot;] for liquid phase, [&quot;gas&quot;] for gas phase, or</span>
<span class="sd">            [&quot;gas&quot;, &quot;solution&quot;] for the full thermodynamic cycle</span>
<span class="sd">        steps (str): whether the redox potential calculation is</span>
<span class="sd">            performed in a single or multi step electron transfer</span>
<span class="sd">            process</span>
<span class="sd">        root_node_key (str): key of the Gaussian run corresponding to</span>
<span class="sd">            the root node in fw_spec</span>
<span class="sd">        keys (list): list of keys of Gaussian runs in fw_spec to use in</span>
<span class="sd">            building the redox potential document; e.g. these keys could</span>
<span class="sd">            correspond to set of optimization and frequency jobs leading</span>
<span class="sd">            to the final result</span>
<span class="sd">        pcet (bool): whether a PCET calculation is performed</span>
<span class="sd">        vertical (bool): whether a vertical IP/EA calculation is</span>
<span class="sd">            performed</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        db (str or dict): database credentials to store the run; could</span>
<span class="sd">            be provided as the path to the db.json file or in the form</span>
<span class="sd">            of a dictionary</span>
<span class="sd">        save_to_db (bool): whether to insert the redox potential dict</span>
<span class="sd">            to the redox potential collection in the db</span>
<span class="sd">        save_to_file (bool): whether to save the redox potential dict</span>
<span class="sd">            to a json file; if True, will save to a file named</span>
<span class="sd">            &quot;ip_ea.json&quot;</span>
<span class="sd">        solvent_gaussian_inputs (str): gaussian inputs for the implicit</span>
<span class="sd">            solvent model to add to the redox potential dict, if any</span>
<span class="sd">        solvent_properties (dict): implicit solvent properties to add</span>
<span class="sd">            to the final redox potential dict, if any</span>
<span class="sd">        electrode_potentials (dict): dictionary of additional electrode</span>
<span class="sd">            potentials to be used in converting the absolute oxidation</span>
<span class="sd">            and reduction potentials to commonly used potential scales;</span>
<span class="sd">            note that the hydrogen, lithium, and magnesium scales are</span>
<span class="sd">            already included; the dictionary should be in the form:</span>
<span class="sd">            {</span>
<span class="sd">             &quot;&lt;metal&gt;&quot;: {</span>
<span class="sd">                        &quot;potential&quot;: &lt;float&gt;,</span>
<span class="sd">                        &quot;ref&quot;: bibtex_parser(&quot;&lt;ref_bib_file&gt;&quot;, dir),</span>
<span class="sd">                    }</span>
<span class="sd">            }</span>
<span class="sd">            Note that bibtex_parser need to be imported from</span>
<span class="sd">            mispr.gaussian.utilities.files</span>
<span class="sd">        additional_prop_doc_fields (dict): additional fields to add to</span>
<span class="sd">            the final redox potential dict</span>
<span class="sd">        gibbs_elec (float): the electron gibbs free energy in Hartree</span>
<span class="sd">        gibbs_h (float): the hydrogen gibbs free energy in Hartree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;num_electrons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;states&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phases&quot;</span><span class="p">,</span>
        <span class="s2">&quot;steps&quot;</span><span class="p">,</span>
        <span class="s2">&quot;root_node_key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keys&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pcet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span>
        <span class="s2">&quot;electrode_potentials&quot;</span><span class="p">,</span>
        <span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gibbs_elec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gibbs_h&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="IPEAtoDB.run_task"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.IPEAtoDB.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
        <span class="n">num_electrons</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;num_electrons&quot;</span><span class="p">]</span>
        <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;phases&quot;</span><span class="p">]</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
        <span class="n">root_node_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;root_node_key&quot;</span><span class="p">]</span>
        <span class="n">pcet</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;pcet&quot;</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span>
        <span class="n">vertical</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;vertical&quot;</span><span class="p">]</span>
        <span class="n">gibbs_elec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gibbs_elec&quot;</span><span class="p">)</span>
        <span class="n">gibbs_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gibbs_h&quot;</span><span class="p">)</span>

        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;../data&quot;</span><span class="p">)</span>
        <span class="n">ref_potentials</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;hydrogen&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;potential&quot;</span><span class="p">:</span> <span class="mf">4.43</span><span class="p">,</span>
                <span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="n">bibtex_parser</span><span class="p">(</span><span class="s2">&quot;h_pot.bib&quot;</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;magnesium&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;potential&quot;</span><span class="p">:</span> <span class="mf">2.375</span><span class="p">,</span>
                <span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="n">bibtex_parser</span><span class="p">(</span><span class="s2">&quot;mg_pot.bib&quot;</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;lithium&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;potential&quot;</span><span class="p">:</span> <span class="mf">1.40</span><span class="p">,</span>
                <span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="n">bibtex_parser</span><span class="p">(</span><span class="s2">&quot;li_pot.bib&quot;</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">electrode_potentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;electrode_potentials&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">electrode_potentials</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">ref_potentials</span><span class="p">,</span> <span class="o">**</span><span class="n">electrode_potentials</span><span class="p">}</span>
        <span class="n">gout_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="c1"># include opt fireworks in the list of gout_dict to calculate run time</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gout_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;_opt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span>
        <span class="p">]</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">full_gout_dict</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="n">process_mol</span><span class="p">(</span>
            <span class="s2">&quot;get_from_run_dict&quot;</span><span class="p">,</span>
            <span class="n">gout_dict</span><span class="p">[</span><span class="n">root_node_key</span><span class="p">],</span>
            <span class="n">charge</span><span class="o">=</span><span class="n">gout_dict</span><span class="p">[</span><span class="n">root_node_key</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">final_energies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;final_energy&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">free_energy_corrections</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;corrections&quot;</span><span class="p">][</span><span class="s2">&quot;Gibbs Free Energy&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">free_energies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">final_energies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">free_energy_corrections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># if one calculation is skipped, wall time is considered zero</span>
        <span class="n">run_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">gout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wall_time (s)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">gout</span> <span class="ow">in</span> <span class="n">full_gout_dict</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">_name_</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pcet</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e1</span><span class="si">}</span><span class="s2">e</span><span class="si">{</span><span class="n">h1</span><span class="si">}</span><span class="s2">h_</span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">e</span><span class="si">{</span><span class="n">h2</span><span class="si">}</span><span class="s2">h&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e1</span><span class="si">}</span><span class="s2">e_</span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">e&quot;</span>

        <span class="k">def</span> <span class="nf">_gibbs_to_redox</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">e_count</span><span class="p">):</span>
            <span class="n">redox_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">s</span> <span class="o">*</span> <span class="n">g</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">HARTREE_TO_KJ</span><span class="p">)</span> <span class="o">*</span> <span class="n">e_count</span> <span class="o">*</span> <span class="n">FARAD</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redox_result</span>

        <span class="k">def</span> <span class="nf">_gibbs_to_pka</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
            <span class="n">pka_result</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">g</span> <span class="o">*</span> <span class="n">HARTREE_TO_KJ</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">R</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mf">298.15</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">pka_result</span>

        <span class="c1"># TODO: PCET --&gt; what to save (IP, EA, pKA, intermediate results)?</span>
        <span class="c1"># TODO: possible to have multiple H transfer in single step? same pka</span>
        <span class="c1">#  calc, divide by 2?</span>
        <span class="c1"># TODO: gibbs_h in gas vs sol or same?</span>
        <span class="n">gibbs_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">redox_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="s2">&quot;oxidation&quot;</span> <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;cation&quot;</span> <span class="k">else</span> <span class="s2">&quot;reduction&quot;</span>
            <span class="n">gibbs_dict</span><span class="p">[</span><span class="n">process</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;anion&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
                <span class="n">gibbs_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># steps not involving h transfer</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pcet</span> <span class="ow">or</span> <span class="n">sign</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">num_electrons</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pcet</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pcet</span><span class="p">)):</span>
                        <span class="n">n1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_0_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">n2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sign</span> <span class="o">*</span> <span class="n">num_electrons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">_name_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">num_electrons</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
                        <span class="n">gibbs</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">free_energies</span><span class="p">[</span><span class="n">n2</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">free_energies</span><span class="p">[</span><span class="n">n1</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">gibbs_elec</span> <span class="o">*</span> <span class="n">num_electrons</span>
                        <span class="p">)</span>
                        <span class="n">gibbs_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gibbs</span> <span class="o">*</span> <span class="n">HARTREE_TO_EV</span>
                        <span class="n">redox</span> <span class="o">=</span> <span class="n">_gibbs_to_redox</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">gibbs</span><span class="p">,</span> <span class="n">num_electrons</span><span class="p">)</span>
                        <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">redox</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">electrode_potentials</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">redox</span> <span class="o">-</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="s2">&quot;multi&quot;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_electrons</span><span class="p">):</span>
                                <span class="n">n1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sign</span> <span class="o">*</span> <span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">n2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">_name_</span><span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
                                <span class="n">gibbs</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">free_energies</span><span class="p">[</span><span class="n">n2</span><span class="p">]</span>
                                    <span class="o">-</span> <span class="n">free_energies</span><span class="p">[</span><span class="n">n1</span><span class="p">]</span>
                                    <span class="o">-</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">gibbs_elec</span>
                                <span class="p">)</span>
                                <span class="n">gibbs_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gibbs</span> <span class="o">*</span> <span class="n">HARTREE_TO_EV</span>
                                <span class="n">redox</span> <span class="o">=</span> <span class="n">_gibbs_to_redox</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">gibbs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">redox</span>
                                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">electrode_potentials</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">redox</span> <span class="o">-</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;potential&quot;</span><span class="p">]</span>
                                    <span class="p">)</span>
                <span class="c1"># steps involving h transfer</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 1st ind --&gt; elec, 2nd ind --&gt; hydrogen</span>
                    <span class="n">n1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_0_0&quot;</span>
                    <span class="n">n2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">num_electrons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">num_electrons</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">_name_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_electrons</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_electrons</span><span class="p">)</span>
                    <span class="n">gibbs</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">free_energies</span><span class="p">[</span><span class="n">n2</span><span class="p">]</span> <span class="o">-</span> <span class="n">free_energies</span><span class="p">[</span><span class="n">n1</span><span class="p">]</span> <span class="o">-</span> <span class="n">gibbs_h</span> <span class="o">*</span> <span class="n">num_electrons</span>
                    <span class="p">)</span>
                    <span class="n">gibbs_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gibbs</span> <span class="o">*</span> <span class="n">HARTREE_TO_EV</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_electrons</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">n1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">_0&quot;</span>
                        <span class="n">n2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">num_electrons</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">_name_</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_electrons</span><span class="p">)</span>
                        <span class="n">gibbs</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">free_energies</span><span class="p">[</span><span class="n">n2</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">free_energies</span><span class="p">[</span><span class="n">n1</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">gibbs_h</span> <span class="o">*</span> <span class="n">num_electrons</span>
                        <span class="p">)</span>
                        <span class="n">pka</span> <span class="o">=</span> <span class="n">_gibbs_to_pka</span><span class="p">(</span><span class="n">gibbs</span><span class="p">)</span>
                        <span class="n">gibbs_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gibbs</span> <span class="o">*</span> <span class="n">HARTREE_TO_EV</span>
                        <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pka</span>
                        <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="s2">&quot;multi&quot;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_electrons</span><span class="p">):</span>
                                <span class="n">n1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">n2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">_name_</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">gibbs</span> <span class="o">=</span> <span class="n">free_energies</span><span class="p">[</span><span class="n">n2</span><span class="p">]</span> <span class="o">-</span> <span class="n">free_energies</span><span class="p">[</span><span class="n">n1</span><span class="p">]</span> <span class="o">-</span> <span class="n">gibbs_h</span>
                                <span class="n">pka</span> <span class="o">=</span> <span class="n">_gibbs_to_pka</span><span class="p">(</span><span class="n">gibbs</span><span class="p">)</span>
                                <span class="n">gibbs_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gibbs</span> <span class="o">*</span> <span class="n">HARTREE_TO_EV</span>
                                <span class="n">redox_dict</span><span class="p">[</span><span class="n">process</span><span class="p">][</span><span class="n">phase</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pka</span>

        <span class="n">mol_schema</span> <span class="o">=</span> <span class="n">get_chem_schema</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
        <span class="n">ip_ea_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;molecule&quot;</span><span class="p">:</span> <span class="n">molecule</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
            <span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">],</span>
            <span class="s2">&quot;inchi&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;inchi&quot;</span><span class="p">],</span>
            <span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">],</span>
            <span class="s2">&quot;chemsys&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;chemsys&quot;</span><span class="p">],</span>
            <span class="s2">&quot;num_electrons&quot;</span><span class="p">:</span> <span class="n">num_electrons</span><span class="p">,</span>
            <span class="s2">&quot;functional&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">root_node_key</span><span class="p">][</span><span class="s2">&quot;functional&quot;</span><span class="p">],</span>
            <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">root_node_key</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">],</span>
            <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">phases</span><span class="p">,</span>
            <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="n">steps</span><span class="p">,</span>
            <span class="s2">&quot;vertical&quot;</span><span class="p">:</span> <span class="n">vertical</span><span class="p">,</span>
            <span class="s2">&quot;pcet&quot;</span><span class="p">:</span> <span class="n">pcet</span><span class="p">,</span>
            <span class="s2">&quot;gibbs_elec&quot;</span><span class="p">:</span> <span class="n">gibbs_elec</span> <span class="o">*</span> <span class="n">HARTREE_TO_EV</span><span class="p">,</span>
            <span class="s2">&quot;gibbs_h&quot;</span><span class="p">:</span> <span class="n">gibbs_h</span> <span class="o">*</span> <span class="n">HARTREE_TO_EV</span><span class="p">,</span>
            <span class="s2">&quot;gibbs&quot;</span><span class="p">:</span> <span class="n">gibbs_dict</span><span class="p">,</span>
            <span class="s2">&quot;potentials&quot;</span><span class="p">:</span> <span class="n">redox_dict</span><span class="p">,</span>
            <span class="s2">&quot;standard_potentials&quot;</span><span class="p">:</span> <span class="n">electrode_potentials</span><span class="p">,</span>
            <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">root_node_key</span><span class="p">][</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;successful&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wall_time (s)&quot;</span><span class="p">:</span> <span class="n">run_time</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">mispr_version</span><span class="p">,</span>
            <span class="s2">&quot;gauss_version&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">root_node_key</span><span class="p">][</span><span class="s2">&quot;gauss_version&quot;</span><span class="p">],</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;solution&quot;</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
            <span class="n">solvent_gaussian_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">)</span>
            <span class="n">solvent_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">ip_ea_dict</span> <span class="o">=</span> <span class="n">add_solvent_to_prop_dict</span><span class="p">(</span>
                <span class="n">ip_ea_dict</span><span class="p">,</span> <span class="n">solvent_gaussian_inputs</span><span class="p">,</span> <span class="n">solvent_properties</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">):</span>
            <span class="n">ip_ea_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">):</span>
            <span class="n">ip_ea_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_db&quot;</span><span class="p">):</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">insert_property</span><span class="p">(</span>
                <span class="s2">&quot;ip_ea&quot;</span><span class="p">,</span>
                <span class="n">ip_ea_dict</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;inchi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;chemsys&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">):</span>
            <span class="n">ip_ea_dict</span><span class="p">[</span><span class="s2">&quot;run_locs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_file&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;run_ids&quot;</span> <span class="ow">in</span> <span class="n">ip_ea_dict</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">ip_ea_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;ip_ea.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">ip_ea_dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DATETIME_HANDLER</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ip/ea calculation complete&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="BDEtoDB"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.BDEtoDB">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">BDEtoDB</span><span class="p">(</span><span class="n">FiretaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enter a bond dissociation energy calculation into the database. The</span>
<span class="sd">    calculation can correspond to one or more bonds in the same</span>
<span class="sd">    molecule.</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        principle_mol_key (str): key of the Gaussian run corresponding</span>
<span class="sd">            to the principle molecule in the fw_spec</span>
<span class="sd">        db (str or dict): database credentials to store the run; could</span>
<span class="sd">            be provided as the path to the db.json file or in the form</span>
<span class="sd">            of a dictionary</span>
<span class="sd">        save_to_db (bool): whether to insert the BDE dict to the BDE</span>
<span class="sd">            collection in the db</span>
<span class="sd">        save_to_file (bool): whether to save the BDE dict to a json</span>
<span class="sd">            file; if True, will save to a file named &quot;bde.json&quot;</span>
<span class="sd">        solvent_gaussian_inputs (str): gaussian inputs for the implicit</span>
<span class="sd">            solvent model to add to the BDE dict, if any</span>
<span class="sd">        solvent_properties (dict): implicit solvent properties to add</span>
<span class="sd">            to the final BDE dict, if any</span>
<span class="sd">        additional_prop_doc_fields (dict): additional fields to add to</span>
<span class="sd">            the final BDE dict</span>
<span class="sd">        visualize (bool): whether to create a bar plot of the BDE</span>
<span class="sd">            results along with the 2D structure of the principle</span>
<span class="sd">            molecule with highlighted broken bonds</span>
<span class="sd">        color (tuple): rgb color to use for highlighting the broken</span>
<span class="sd">            bonds in the molecule; e.g. (0.0, 0.0, 0.0) for black;</span>
<span class="sd">            if not provided, will use (197 / 255, 237 / 255, 223 / 255, 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;principle_mol_key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_db&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_to_file&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span>
        <span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;visualize&quot;</span><span class="p">,</span>
        <span class="s2">&quot;color&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="BDEtoDB.run_task"><a class="viewcode-back" href="../../../../mispr.gaussian.firetasks.html#mispr.gaussian.firetasks.parse_outputs.BDEtoDB.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">)</span>
        <span class="n">principle_mol_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;principle_mol_key&quot;</span><span class="p">,</span> <span class="s2">&quot;ref_mol&quot;</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">principle_mol_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;frag_keys&quot;</span><span class="p">]</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">]</span>
        <span class="n">molecule_indices</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;molecule_indices&quot;</span><span class="p">]</span>
        <span class="n">gout_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="c1"># include opt fireworks in the list of gout_dict to calculate run time</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gout_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">pass_gout_dict</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;_opt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span>
        <span class="p">]</span>
        <span class="n">full_gout_dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">full_gout_dict</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="n">process_mol</span><span class="p">(</span>
            <span class="s2">&quot;get_from_run_dict&quot;</span><span class="p">,</span>
            <span class="n">gout_dict</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">],</span>
            <span class="n">charge</span><span class="o">=</span><span class="n">gout_dict</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">][</span><span class="s2">&quot;phase&quot;</span><span class="p">]</span>
        <span class="n">final_energies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;final_energy&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">enthalpy_corrections</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="n">j</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="s2">&quot;corrections&quot;</span><span class="p">][</span><span class="s2">&quot;Enthalpy&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">enthalpies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">final_energies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">enthalpy_corrections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">run_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">gout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wall_time (s)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">gout</span> <span class="ow">in</span> <span class="n">full_gout_dict</span><span class="p">])</span>

        <span class="n">fragments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">gout_key</span><span class="p">,</span> <span class="n">gout</span> <span class="ow">in</span> <span class="n">gout_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">gout_key</span> <span class="o">!=</span> <span class="n">principle_mol_key</span><span class="p">:</span>
                <span class="n">frag</span> <span class="o">=</span> <span class="n">process_mol</span><span class="p">(</span>
                    <span class="s2">&quot;get_from_run_dict&quot;</span><span class="p">,</span> <span class="n">gout</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">gout</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">frag_schema</span> <span class="o">=</span> <span class="n">get_chem_schema</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span>
                <span class="n">fragments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="n">gout_key</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;fragment&quot;</span><span class="p">:</span> <span class="n">frag</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                            <span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="n">frag_schema</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;inchi&quot;</span><span class="p">:</span> <span class="n">frag_schema</span><span class="p">[</span><span class="s2">&quot;inchi&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">:</span> <span class="n">frag_schema</span><span class="p">[</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;chemsys&quot;</span><span class="p">:</span> <span class="n">frag_schema</span><span class="p">[</span><span class="s2">&quot;chemsys&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">final_energies</span><span class="p">[</span><span class="n">gout_key</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="n">bde_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="p">[</span><span class="n">bond</span><span class="p">,</span> <span class="n">mol_ind</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bonds</span><span class="p">,</span> <span class="n">molecule_indices</span><span class="p">)):</span>
            <span class="n">frag_pairs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_ind</span><span class="p">):</span>
                <span class="n">frag_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">))]</span>
                <span class="n">frag_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;frag_</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">frag_ind</span><span class="p">])</span>
                <span class="c1"># try to calculate BDE from fragment pair results;</span>
                <span class="c1"># if the fragment is not found because the calculation failed,</span>
                <span class="c1"># move to the next pair and throw a warning</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fragment_energies_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">enthalpies</span><span class="p">[</span><span class="n">frag</span><span class="p">]</span> <span class="k">for</span> <span class="n">frag</span> <span class="ow">in</span> <span class="n">frag_tuple</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">frag_pairs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">frag_ind</span><span class="p">):</span> <span class="p">(</span>
                                <span class="n">fragment_energies_sum</span> <span class="o">-</span> <span class="n">enthalpies</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="o">*</span> <span class="n">HARTREE_TO_EV</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Results not found for pairs: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frag_tuple</span><span class="p">))</span>
            <span class="n">bde_results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">bond</span><span class="p">):</span> <span class="n">frag_pairs</span><span class="p">})</span>

        <span class="c1"># if at least one BDE is calculated, continue with creating final dict</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">bde_results</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">mol_schema</span> <span class="o">=</span> <span class="n">get_chem_schema</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
            <span class="n">bde_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;molecule&quot;</span><span class="p">:</span> <span class="n">molecule</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                <span class="s2">&quot;smiles&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">],</span>
                <span class="s2">&quot;inchi&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;inchi&quot;</span><span class="p">],</span>
                <span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">],</span>
                <span class="s2">&quot;chemsys&quot;</span><span class="p">:</span> <span class="n">mol_schema</span><span class="p">[</span><span class="s2">&quot;chemsys&quot;</span><span class="p">],</span>
                <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">final_energies</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">],</span>
                <span class="s2">&quot;functional&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">][</span><span class="s2">&quot;functional&quot;</span><span class="p">],</span>
                <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">][</span><span class="s2">&quot;basis&quot;</span><span class="p">],</span>
                <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="p">,</span>
                <span class="s2">&quot;fragments&quot;</span><span class="p">:</span> <span class="n">fragments</span><span class="p">,</span>
                <span class="s2">&quot;bde_eV&quot;</span><span class="p">:</span> <span class="n">bde_results</span><span class="p">,</span>
                <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">][</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;successful&quot;</span><span class="p">,</span>
                <span class="s2">&quot;wall_time (s)&quot;</span><span class="p">:</span> <span class="n">run_time</span><span class="p">,</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">mispr_version</span><span class="p">,</span>
                <span class="s2">&quot;gauss_version&quot;</span><span class="p">:</span> <span class="n">gout_dict</span><span class="p">[</span><span class="n">principle_mol_key</span><span class="p">][</span><span class="s2">&quot;gauss_version&quot;</span><span class="p">],</span>
                <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;solution&quot;</span><span class="p">:</span>
                <span class="n">solvent_gaussian_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_gaussian_inputs&quot;</span><span class="p">)</span>
                <span class="n">solvent_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solvent_properties&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">bde_dict</span> <span class="o">=</span> <span class="n">add_solvent_to_prop_dict</span><span class="p">(</span>
                    <span class="n">bde_dict</span><span class="p">,</span> <span class="n">solvent_gaussian_inputs</span><span class="p">,</span> <span class="n">solvent_properties</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;visualize&quot;</span><span class="p">):</span>
                <span class="c1"># if RDKit is not installed, throw a warning message and proceed</span>
                <span class="c1"># normally; visualization will not be done</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">num_bonds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
                    <span class="n">rdkit_mol</span> <span class="o">=</span> <span class="n">get_rdkit_mol</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">197</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">237</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">223</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">max_bond</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># max # of bonds above which to change sizes</span>
                    <span class="n">fig_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">num_bonds</span> <span class="o">/</span> <span class="n">max_bond</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>
                    <span class="p">)</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">draw_rdkit_mol_with_highlighted_bonds</span><span class="p">(</span>
                        <span class="n">rdkit_mol</span><span class="p">,</span>
                        <span class="n">bonds</span><span class="p">,</span>
                        <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">color</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_bonds</span><span class="p">,</span>
                        <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;mol_bonds.png&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">picture</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                        <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">,</span>
                        <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]},</span>
                    <span class="p">)</span>

                    <span class="n">mol_image</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;mol_bonds.png&quot;</span><span class="p">)</span>
                    <span class="n">picture</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mol_image</span><span class="p">)</span>
                    <span class="n">picture</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;mol_bonds.png&quot;</span><span class="p">)</span>

                    <span class="n">margin</span> <span class="o">=</span> <span class="mf">0.2</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">/</span> <span class="n">num_bonds</span>
                    <span class="n">gap</span> <span class="o">=</span> <span class="n">num_bonds</span> <span class="o">+</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">width</span>
                    <span class="n">x_ticks</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">xtick_labels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">bond</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bonds</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">gap</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bde_results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">bond</span><span class="p">)]))</span>
                        <span class="p">]</span>
                        <span class="n">gap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_bonds</span> <span class="o">/</span> <span class="n">max_bond</span><span class="p">)</span>
                        <span class="n">x_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="c1"># xtick_labels.append(</span>
                        <span class="c1">#     &#39;{}:{}-{}&#39;.format(str(ind),</span>
                        <span class="c1">#                       (str(molecule.species[bond[0]])),</span>
                        <span class="c1">#                       (str(molecule.species[bond[1]]))))</span>
                        <span class="n">xtick_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)))</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                            <span class="n">data</span><span class="p">,</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">bde_results</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">bond</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                            <span class="n">width</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                            <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_data_ratio</span><span class="p">(),</span> <span class="n">adjustable</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_ticks</span><span class="p">))</span>
                    <span class="c1"># ax.set_xticklabels(xtick_labels, rotation=45)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtick_labels</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Bond number&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;BDE (eV)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;bde.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">):</span>
                <span class="n">bde_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;additional_prop_doc_fields&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">):</span>
                <span class="n">bde_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_id_list&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_db&quot;</span><span class="p">):</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">insert_property</span><span class="p">(</span>
                    <span class="s2">&quot;bde&quot;</span><span class="p">,</span>
                    <span class="n">bde_dict</span><span class="p">,</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;formula_alphabetical&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;smiles&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;inchi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;chemsys&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;functional&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">):</span>
                <span class="n">bde_dict</span><span class="p">[</span><span class="s2">&quot;run_locs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s2">&quot;run_loc_list&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_to_file&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;run_ids&quot;</span> <span class="ow">in</span> <span class="n">bde_dict</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">bde_dict</span><span class="p">[</span><span class="s2">&quot;run_ids&quot;</span><span class="p">]</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;bde.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bde_dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DATETIME_HANDLER</span><span class="p">))</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;bde calculation complete&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No BDE was calculated. Exiting ...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, MolMD Group
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/molmd/mispr" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/scripts/furo.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/tabs.js"></script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script src="../../../../_static/js/rtd_sphinx_search.min.js"></script>
    </body>
</html>